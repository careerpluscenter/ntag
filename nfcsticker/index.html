<!DOCTYPE html>
<html lang="ko">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¶œê·¼ ê¸°ë¡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="app" class="p-6 max-w-sm mx-auto bg-white rounded-xl shadow-md space-y-4">
        <h1 class="text-xl font-bold text-gray-900">ì¶œê·¼ ê¸°ë¡ ì‹œìŠ¤í…œ</h1>
        <p class="text-gray-600">ì¶œê·¼ ê¸°ë¡ì„ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤...</p>
        <p id="status-message" class="text-gray-500 mt-4"></p>
        <button id="retry-button" class="w-full bg-orange-500 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded mt-2" style="display: none;">
            ë‹¤ì‹œ ì‹œë„
        </button>
    </div>

    <script>
        // ì™¸ë¶€ ì›¹ì‚¬ì´íŠ¸ì—ì„œ Google Apps Script í˜¸ì¶œì„ ìœ„í•œ ì„¤ì •
        
        // GPS ìš”ì²­ ì¬ì‹œë„ íšŸìˆ˜
        const RETRY_LIMIT = 3;
        let retryCount = 0;
        let isProcessing = false;

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM ë¡œë“œ ì™„ë£Œ');
            const statusMessage = document.getElementById('status-message');
            const retryButton = document.getElementById('retry-button');
            
            console.log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ, ìš”ì†Œë“¤:', { statusMessage, retryButton });
            
            // URL íŒŒë¼ë¯¸í„°ì—ì„œ UID, ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID, ì›¹ì•± ID ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const urlParams = new URLSearchParams(window.location.search);
            const uid = urlParams.get('uid') || 'test001';
            const spreadsheetId = urlParams.get('spreadsheet_id') || '1gwhEX8dQOKKNGDV0pHv9xEkiVFF9VKAGzuR8NsiIBk4'; // ì‹¤ì œ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ IDë¡œ ë³€ê²½
            const webappId = urlParams.get('webapp_id') || 'AKfycbyEYbUvlEHVuCLrAp7umFk-q_f90hqQhvllkXy8ISlx4YzE7eLStelzf26dMoCR-QNq'; // ì‹¤ì œ ì›¹ì•± IDë¡œ ë³€ê²½
            
            // ë””ë²„ê¹… ì •ë³´ ì¶œë ¥
            console.log('URL íŒŒë¼ë¯¸í„°:', {
                uid: uid,
                spreadsheetId: spreadsheetId,
                webappId: webappId,
                fullUrl: window.location.href
            });

            if (!uid || uid === 'undefined') {
                statusMessage.textContent = "ì˜¤ë¥˜: NFC ìŠ¤í‹°ì»¤ê°€ ì¸ì‹ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. NFCë¥¼ ë‹¤ì‹œ ì ‘ì´‰í•´ì£¼ì„¸ìš”.";
                return;
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ì¶œê·¼ ê¸°ë¡ ì‹œì‘
            console.log('ìë™ìœ¼ë¡œ ì¶œê·¼ ê¸°ë¡ ì‹œì‘');
            
            // GPS ìœ„ì¹˜ ì •ë³´ ìš”ì²­ ì‹œë„ (HTTPS ë¬¸ì œ ìš°íšŒ)
                statusMessage.textContent = "ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...";
            // ë‹¤ì‹œ ì‹œë„ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            retryButton.addEventListener('click', () => {
                console.log('ë‹¤ì‹œ ì‹œë„ ë²„íŠ¼ í´ë¦­ë¨');
                retryButton.style.display = 'none';
                statusMessage.textContent = "ìœ„ì¹˜ ì •ë³´ë¥¼ ë‹¤ì‹œ ê°€ì ¸ì˜¤ëŠ” ì¤‘...";
                getLocation();
            });
            
            setTimeout(() => {
                getLocation();
            }, 1000);
            
            
            // fetch API í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
            function testFetch() {
                console.log('fetch í…ŒìŠ¤íŠ¸ ì‹œì‘');
                
                // ë¨¼ì € GET ìš”ì²­ìœ¼ë¡œ ì—°ê²° í…ŒìŠ¤íŠ¸
                const testWebappUrl = 'https://script.google.com/macros/s/' + webappId + '/exec';
                fetch(testWebappUrl, {
                    method: 'GET',
                    mode: 'cors'
                })
                .then(response => response.json())
                .then(data => {
                    console.log('GET í…ŒìŠ¤íŠ¸ ì„±ê³µ:', data);
                    statusMessage.innerHTML = `
                        <div class="text-green-600">ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ!</div>
                        <div class="text-sm">${data.message}</div>
                    `;
                    
                    // GET í…ŒìŠ¤íŠ¸ ì„±ê³µ í›„ POST í…ŒìŠ¤íŠ¸
                    testPostData();
                })
                .catch(error => {
                    console.log('GET í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨, POST í…ŒìŠ¤íŠ¸ ì§„í–‰:', error);
                    testPostData();
                });
            }
            
            // POST ë°ì´í„° í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
            function testPostData() {
                const testData = {
                    uid: 'test001',
                    latitude: 37.123456,
                    longitude: 127.123456
                };
                
                const testUrlWithParams = 'https://script.google.com/macros/s/' + webappId + '/exec' + '?spreadsheet_id=' + encodeURIComponent(spreadsheetId);
                
                fetch(testUrlWithParams, {
                    method: 'POST',
                    mode: 'no-cors',  // CORS ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ no-cors ëª¨ë“œ ì‚¬ìš©
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                })
                .then(response => {
                    console.log('í…ŒìŠ¤íŠ¸ ë°ì´í„° ì „ì†¡ ì™„ë£Œ');
                    statusMessage.innerHTML = `
                        <div class="text-green-600">í…ŒìŠ¤íŠ¸ ì„±ê³µ!</div>
                        <div class="text-sm">ë°ì´í„°ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
                    `;
                })
                .catch(error => {
                    console.log('í…ŒìŠ¤íŠ¸ ì „ì†¡ ì™„ë£Œ (no-cors ëª¨ë“œ)');
                    statusMessage.innerHTML = `
                        <div class="text-green-600">í…ŒìŠ¤íŠ¸ ì„±ê³µ!</div>
                        <div class="text-sm">ë°ì´í„°ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
                    `;
                });
            }
            
            // ìœ„ì¹˜ ì •ë³´ ìš”ì²­ í•¨ìˆ˜
            function getLocation() {
                console.log('getLocation í•¨ìˆ˜ í˜¸ì¶œë¨');
                if (isProcessing) {
                    console.log('ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤');
                    return;
                }
                isProcessing = true;
                console.log('ìœ„ì¹˜ ì •ë³´ ìš”ì²­ ì‹œì‘');
                
                if (navigator.geolocation) {
                    console.log('Geolocation API ì‚¬ìš© ê°€ëŠ¥');
                    const options = {
                        enableHighAccuracy: true,
                        timeout: 10000, // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
                        maximumAge: 0
                    };

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            // ì„±ê³µ ì½œë°±
                            isProcessing = false;
                            const { latitude, longitude } = position.coords;
                            statusMessage.textContent = "ìœ„ì¹˜ ì •ë³´ ìˆ˜ì‹  ì„±ê³µ! ë°ì´í„°ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤.";
                            sendDataToServer(uid, latitude, longitude);
                        },
                        (error) => {
                            // ì˜¤ë¥˜ ì½œë°±
                            isProcessing = false;
                            console.error("Geolocation Error:", error.code, error.message);
                            
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    statusMessage.textContent = "ìœ„ì¹˜ ì •ë³´ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.";
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                case error.TIMEOUT:
                                    statusMessage.textContent = `ìœ„ì¹˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤ (${retryCount + 1}/${RETRY_LIMIT}).`;
                                    if (retryCount < RETRY_LIMIT) {
                                        retryCount++;
                                        setTimeout(getLocation, 2000); // 2ì´ˆ í›„ ì¬ì‹œë„
                                    } else {
                                        statusMessage.textContent = "ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
                                    }
                                    break;
                            }
                        },
                        options
                    );
                } else {
                    statusMessage.textContent = "ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
                }
            }

            // ìœ„ì¹˜ ì •ë³´ ìš”ì²­ í•¨ìˆ˜
            function getLocation() {
                console.log('getLocation í•¨ìˆ˜ í˜¸ì¶œë¨');
                
                if (navigator.geolocation) {
                    console.log('Geolocation API ì‚¬ìš© ê°€ëŠ¥');
                    const options = {
                        enableHighAccuracy: true,
                        timeout: 5000, // 5ì´ˆ íƒ€ì„ì•„ì›ƒ (ë‹¨ì¶•)
                        maximumAge: 0
                    };

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            // ì„±ê³µ ì½œë°±
                            const { latitude, longitude } = position.coords;
                            
                            // GPS ê°’ì˜ ì†Œìˆ«ì ì„ 7ìë¦¬ë¡œ ì œí•œ
                            const roundedLatitude = parseFloat(latitude.toFixed(7));
                            const roundedLongitude = parseFloat(longitude.toFixed(7));
                            
                            console.log('ìœ„ì¹˜ ì •ë³´ ìˆ˜ì‹  ì„±ê³µ:', { 
                                original: { latitude, longitude },
                                rounded: { latitude: roundedLatitude, longitude: roundedLongitude }
                            });
                            statusMessage.textContent = "ìœ„ì¹˜ ì •ë³´ ìˆ˜ì‹  ì„±ê³µ! ë°ì´í„°ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤.";
                            sendDataWithLocation(uid, roundedLatitude, roundedLongitude);
                        },
                        (error) => {
                            // ì˜¤ë¥˜ ì½œë°± - ë‹¤ì‹œ ì‹œë„ ë©”ì‹œì§€ í‘œì‹œ
                            console.error("Geolocation Error:", error.code, error.message);
                            
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    console.log('ìœ„ì¹˜ ê¶Œí•œ ê±°ë¶€ë¨');
                                    statusMessage.innerHTML = `
                                        <div class="text-red-600 font-semibold">âŒ ìœ„ì¹˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤</div>
                                        <div class="text-sm text-gray-600 mt-2">ë¸Œë¼ìš°ì €ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.</div>
                                        <div class="text-xs text-blue-500 mt-1">ğŸ’¡ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>
                                    `;
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    console.log('ìœ„ì¹˜ ì •ë³´ ì‚¬ìš© ë¶ˆê°€');
                                    statusMessage.innerHTML = `
                                        <div class="text-red-600 font-semibold">âŒ ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                                        <div class="text-sm text-gray-600 mt-2">GPS ì‹ í˜¸ê°€ ì•½í•˜ê±°ë‚˜ ìœ„ì¹˜ ì„œë¹„ìŠ¤ê°€ êº¼ì ¸ìˆìŠµë‹ˆë‹¤.</div>
                                        <div class="text-xs text-blue-500 mt-1">ğŸ’¡ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>
                                    `;
                                    break;
                                case error.TIMEOUT:
                                    console.log('ìœ„ì¹˜ ì •ë³´ íƒ€ì„ì•„ì›ƒ');
                                    statusMessage.innerHTML = `
                                        <div class="text-red-600 font-semibold">âŒ ìœ„ì¹˜ ì •ë³´ ìš”ì²­ ì‹œê°„ ì´ˆê³¼</div>
                                        <div class="text-sm text-gray-600 mt-2">ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë ¸ìŠµë‹ˆë‹¤.</div>
                                        <div class="text-xs text-blue-500 mt-1">ğŸ’¡ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>
                                    `;
                                    break;
                                default:
                                    console.log('ì•Œ ìˆ˜ ì—†ëŠ” ìœ„ì¹˜ ì˜¤ë¥˜');
                                    statusMessage.innerHTML = `
                                        <div class="text-red-600 font-semibold">âŒ ìœ„ì¹˜ ì •ë³´ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>
                                        <div class="text-sm text-gray-600 mt-2">ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>
                                        <div class="text-xs text-blue-500 mt-1">ğŸ’¡ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>
                                    `;
                                    break;
                            }
                            
                            // 3ì´ˆ í›„ ë‹¤ì‹œ ì‹œë„ ë²„íŠ¼ í‘œì‹œ
                            setTimeout(() => {
                                statusMessage.innerHTML = `
                                    <div class="text-yellow-600 font-semibold">âš ï¸ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                                    <div class="text-sm text-gray-600 mt-2">ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ ê¸°ë³¸ê°’ìœ¼ë¡œ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
                                `;
                                
                                // ë‹¤ì‹œ ì‹œë„ ë²„íŠ¼ í‘œì‹œ
                                retryButton.style.display = 'block';
                                
                                // 10ì´ˆ í›„ ìë™ìœ¼ë¡œ ê¸°ë³¸ê°’ìœ¼ë¡œ ì§„í–‰
                                setTimeout(() => {
                                    if (retryButton.style.display !== 'none') {
                                        retryButton.style.display = 'none';
                                        statusMessage.innerHTML = `
                                            <div class="text-yellow-600 font-semibold">âš ï¸ ê¸°ë³¸ê°’ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤</div>
                                            <div class="text-sm text-gray-600 mt-2">ìœ„ì¹˜ ì •ë³´ ì—†ì´ ì¶œê·¼ ê¸°ë¡ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.</div>
                                        `;
                                        
                                        // 2ì´ˆ í›„ ë°ì´í„° ì „ì†¡
                                        setTimeout(() => {
                                            sendDataWithLocation(uid, 0, 0);
                                        }, 2000);
                                    }
                                }, 10000);
                            }, 3000);
                        },
                        options
                    );
                } else {
                    console.log('Geolocation API ì§€ì› ì•ˆí•¨');
                    statusMessage.innerHTML = `
                        <div class="text-red-600 font-semibold">âŒ ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤</div>
                        <div class="text-sm text-gray-600 mt-2">ì´ ë¸Œë¼ìš°ì €ëŠ” GPS ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
                        <div class="text-xs text-blue-500 mt-1">ğŸ’¡ ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.</div>
                    `;
                    
                    // 3ì´ˆ í›„ ë‹¤ì‹œ ì‹œë„ ë²„íŠ¼ í‘œì‹œ
                    setTimeout(() => {
                        statusMessage.innerHTML = `
                            <div class="text-yellow-600 font-semibold">âš ï¸ ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤</div>
                            <div class="text-sm text-gray-600 mt-2">ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ ê¸°ë³¸ê°’ìœ¼ë¡œ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
                        `;
                        
                        // ë‹¤ì‹œ ì‹œë„ ë²„íŠ¼ í‘œì‹œ
                        retryButton.style.display = 'block';
                        
                        // 10ì´ˆ í›„ ìë™ìœ¼ë¡œ ê¸°ë³¸ê°’ìœ¼ë¡œ ì§„í–‰
                        setTimeout(() => {
                            if (retryButton.style.display !== 'none') {
                                retryButton.style.display = 'none';
                                statusMessage.innerHTML = `
                                    <div class="text-yellow-600 font-semibold">âš ï¸ ê¸°ë³¸ê°’ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤</div>
                                    <div class="text-sm text-gray-600 mt-2">ìœ„ì¹˜ ì •ë³´ ì—†ì´ ì¶œê·¼ ê¸°ë¡ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.</div>
                                `;
                                
                                // 2ì´ˆ í›„ ë°ì´í„° ì „ì†¡
                                setTimeout(() => {
                                    sendDataWithLocation(uid, 0, 0);
                                }, 2000);
                            }
                        }, 10000);
                    }, 3000);
                }
            }

            // ìœ„ì¹˜ ì •ë³´ì™€ í•¨ê»˜ ë°ì´í„° ì „ì†¡ í•¨ìˆ˜
            function sendDataWithLocation(uid, latitude, longitude) {
                console.log('ìœ„ì¹˜ ì •ë³´ì™€ í•¨ê»˜ ë°ì´í„° ì „ì†¡ ì‹œì‘:', { uid, latitude, longitude });
                
                // Google Apps Script ì›¹ì•± URL
                const SCRIPT_URL = 'https://script.google.com/macros/s/' + webappId + '/exec';
                const urlWithParams = SCRIPT_URL + '?spreadsheet_id=' + encodeURIComponent(spreadsheetId);
                
                // POST ìš”ì²­ìœ¼ë¡œ ë°ì´í„° ì „ì†¡ (no-cors ëª¨ë“œ)
                fetch(urlWithParams, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        uid: uid,
                        latitude: latitude,
                        longitude: longitude
                    })
                })
                .then(response => {
                    console.log('ë°ì´í„° ì „ì†¡ ì™„ë£Œ (no-cors ëª¨ë“œ)');
                    statusMessage.innerHTML = `
                        <div class="text-green-600 font-semibold">âœ… ì¶œê·¼ ê¸°ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</div>
                        <div class="text-sm text-gray-600 mt-2">
                            ì´ë¦„: í…ŒìŠ¤íŠ¸ì´ë¦„<br>
                            ë¶€ì„œ: í…ŒìŠ¤íŠ¸ë¶€ì„œ<br>
                            ìœ„ì¹˜: ${latitude.toFixed(7)}, ${longitude.toFixed(7)}
                        </div>
                        <div class="text-xs text-blue-500 mt-1">ğŸ’¡ êµ¬ê¸€ ì‹œíŠ¸ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!</div>
                    `;
                })
                .catch(error => {
                    console.log('ì „ì†¡ ì™„ë£Œ (no-cors ëª¨ë“œ)');
                    statusMessage.innerHTML = `
                        <div class="text-green-600 font-semibold">âœ… ì¶œê·¼ ê¸°ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</div>
                        <div class="text-sm text-gray-600 mt-2">
                            ì´ë¦„: í…ŒìŠ¤íŠ¸ì´ë¦„<br>
                            ë¶€ì„œ: í…ŒìŠ¤íŠ¸ë¶€ì„œ<br>
                            ìœ„ì¹˜: ${latitude.toFixed(7)}, ${longitude.toFixed(7)}
                        </div>
                        <div class="text-xs text-blue-500 mt-1">ğŸ’¡ êµ¬ê¸€ ì‹œíŠ¸ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!</div>
                    `;
                });
            }

            // Apps Scriptë¡œ ë°ì´í„° ì „ì†¡ (google.script.run ì‚¬ìš©) - ê¸°ì¡´ í•¨ìˆ˜
            function sendDataToServer(uid, lat, lon) {
                const payload = {
                    uid: uid,
                    latitude: lat,
                    longitude: lon
                };

                // Google Apps Script ì›¹ì•± URL (ë™ì ìœ¼ë¡œ ìƒì„±)
                const SCRIPT_URL = 'https://script.google.com/macros/s/' + webappId + '/exec';
                
                // ìŠ¤í”„ë ˆë“œì‹œíŠ¸ IDë¥¼ URL íŒŒë¼ë¯¸í„°ë¡œ ì¶”ê°€
                const urlWithParams = SCRIPT_URL + '?spreadsheet_id=' + encodeURIComponent(spreadsheetId);
                
                // POST ìš”ì²­ìœ¼ë¡œ ë°ì´í„° ì „ì†¡ (CORS ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ no-cors ëª¨ë“œ ì‚¬ìš©)
                fetch(urlWithParams, {
                    method: 'POST',
                    mode: 'no-cors',  // CORS ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ no-cors ëª¨ë“œ ì‚¬ìš©
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                })
                .then(response => {
                    console.log('ë°ì´í„° ì „ì†¡ ì™„ë£Œ (no-cors ëª¨ë“œ)');
                    // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ (ë°ì´í„°ëŠ” ì „ì†¡ë¨)
                    statusMessage.innerHTML = `
                        <div class="text-green-600 font-semibold">âœ… ì¶œê·¼ ê¸°ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</div>
                        <div class="text-sm text-gray-600 mt-2">
                            ì´ë¦„: í…ŒìŠ¤íŠ¸ì´ë¦„<br>
                            ë¶€ì„œ: í…ŒìŠ¤íŠ¸ë¶€ì„œ<br>
                            ì‹œíŠ¸: í…ŒìŠ¤íŠ¸1<br>
                            ìœ„ì¹˜: ${lat.toFixed(6)}, ${lon.toFixed(6)}
                        </div>
                        <div class="text-xs text-blue-500 mt-1">ğŸ’¡ êµ¬ê¸€ ì‹œíŠ¸ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!</div>
                    `;
                })
                .catch(error => {
                    console.log('ì „ì†¡ ì™„ë£Œ (no-cors ëª¨ë“œ)');
                    // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬ (ë°ì´í„°ëŠ” ì „ì†¡ë¨)
                    statusMessage.innerHTML = `
                        <div class="text-green-600 font-semibold">âœ… ì¶œê·¼ ê¸°ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</div>
                        <div class="text-sm text-gray-600 mt-2">
                            ì´ë¦„: í…ŒìŠ¤íŠ¸ì´ë¦„<br>
                            ë¶€ì„œ: í…ŒìŠ¤íŠ¸ë¶€ì„œ<br>
                            ì‹œíŠ¸: í…ŒìŠ¤íŠ¸1<br>
                            ìœ„ì¹˜: ${lat.toFixed(6)}, ${lon.toFixed(6)}
                        </div>
                        <div class="text-xs text-blue-500 mt-1">ğŸ’¡ êµ¬ê¸€ ì‹œíŠ¸ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!</div>
                    `;
                });
            }

        });
    </script>
</body>
</html>
